<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Penjualan ‚Äî Mingguan (V2)</title>
  <meta name="description" content="Dashboard penjualan mingguan: tren, deviasi, top brand, scatter stok vs penjualan. Auto-load dari Data Penjualan.txt" />
  <script src="https://cdn.jsdelivr.net"></script>
  <script src="https://unpkg.com"></script>
  <!-- ECharts 5: CDN -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
 <style>  
  :root {
      --bg: #0b0c0f;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --card: #111827;
      --accent: #60a5fa;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --link: #93c5fd;
      --chip: #1f2937;
      --chip-border: #374151;
      --border: #1f2937;
      --shadow: 0 1px 0 rgba(255,255,255,0.02) inset, 0 8px 24px rgba(0,0,0,0.25);
    }
    .light {
      --bg: #f8fafc;
      --fg: #0b0c0f;
      --muted: #475569;
      --card: #ffffff;
      --accent: #2563eb;
      --ok: #059669;
      --warn: #d97706;
      --bad: #dc2626;
      --link: #1d4ed8;
      --chip: #eef2ff;
      --chip-border: #c7d2fe;
      --border: #e5e7eb;
      --shadow: 0 1px 0 rgba(0,0,0,0.02) inset, 0 8px 24px rgba(0,0,0,0.06);
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      transition: background .25s ease, color .25s ease;
    }
    a { color: var(--link); text-decoration: none; }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 24px 16px 56px; }
    header { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; margin-bottom: 12px; }
    h1 { font-size: 20px; margin: 0; }
    .status { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn, button {
      background: var(--accent); color: white; border: 0; border-radius: 8px; padding: 8px 12px;
      font-weight: 600; cursor: pointer; box-shadow: var(--shadow);
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .ghost { background: transparent; color: var(--fg); border: 1px solid var(--border); }
    .danger { background: var(--bad); }
    .ok { background: var(--ok); }
    .toggle {
      background: transparent; color: var(--fg); border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 999px; cursor: pointer;
    }
    .chip {
      display: inline-block; padding: 4px 8px; border-radius: 999px; background: var(--chip);
      border: 1px solid var(--chip-border); color: var(--fg); font-size: 12px; margin-right: 6px;
    }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px;
      box-shadow: var(--shadow);
    }
    .card h3 { margin: 4px 0 10px; font-size: 16px; }
    .card p { margin: 6px 0; }
    .cols-6 { grid-column: span 6; }
    .cols-4 { grid-column: span 4; }
    .cols-8 { grid-column: span 8; }
    .cols-12 { grid-column: span 12; }
    @media (max-width: 980px) {
      .cols-6, .cols-8, .cols-4 { grid-column: span 12; }
    }
    details { border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; background: var(--card); }
    summary { cursor: pointer; font-weight: 700; }
    .filters { display: grid; gap: 8px; grid-template-columns: repeat(6, minmax(140px, 1fr)); }
    .filters > div { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; color: var(--muted); }
    select, input[type="number"] {
      background: transparent; color: var(--fg); border: 1px solid var(--border);
      padding: 8px; border-radius: 8px;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .split { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .kpi { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .kpi .tile { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .kpi .big { font-size: 20px; font-weight: 800; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    .note { color: var(--muted); font-size: 12px; }
    .right { text-align: right; }
    .chart { width: 100%; height: 360px; }
    .small { height: 300px; }
    .sep { height: 1px; background: var(--border); margin: 8px 0; }
    .footer { color: var(--muted); margin-top: 36px; font-size: 12px; }
  </style>
</head>
<body class="light">
  <div class="wrap">
    <header>
      <div>
        <h1>Dashboard Penjualan ‚Äî Mingguan (V2)</h1>
        <div class="status" id="status">Menyiapkan‚Ä¶</div>
      </div>
      <div class="toolbar">
        <button class="toggle" id="themeBtn" title="Toggle Tema">üåô / ‚òÄÔ∏è</button>
        <div class="row" role="radiogroup" aria-label="Unit">
          <span class="chip">Unit</span>
          <label><input type="radio" name="unit" value="pac" checked> Pack</label>
          <label><input type="radio" name="unit" value="th"> TH Stick</label>
        </div>
        <button class="ghost" id="btnExportCSV">Ekspor CSV (Filter)</button>
      </div>
    </header>

    <details open>
      <summary>Filter</summary>
      <div class="sep"></div>
      <div class="filters" style="margin-top:8px;">
        <div>
          <label for="weekMin">Week (min)</label>
          <input type="number" id="weekMin" min="1" step="1" placeholder="min"/>
        </div>
        <div>
          <label for="weekMax">Week (max)</label>
          <input type="number" id="weekMax" min="1" step="1" placeholder="max"/>
        </div>
        <div>
          <label for="regionSel">Region</label>
          <select id="regionSel" multiple size="6"></select>
        </div>
        <div>
          <label for="areaSel">Area</label>
          <select id="areaSel" multiple size="6"></select>
        </div>
        <div>
          <label for="typeSel">Type</label>
          <select id="typeSel" multiple size="6"></select>
        </div>
        <div>
          <label for="brandSel">Brand</label>
          <select id="brandSel" multiple size="6"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="applyBtn" class="btn">Terapkan Filter</button>
        <button id="resetBtn" class="ghost">Reset Filter</button>
        <span class="note" id="selInfo"></span>
      </div>
    </details>

    <div class="kpi" style="margin-top:12px;">
      <div class="tile">
        <div>Total SV</div>
        <div id="kpiSV" class="big">‚Äì</div>
        <div class="note">Satuan mengikuti Unit</div>
      </div>
      <div class="tile">
        <div>Rata-rata SV / Week</div>
        <div id="kpiSVAvg" class="big">‚Äì</div>
        <div class="note">Berdasar range Week terpilih</div>
      </div>
      <div class="tile">
        <div>Brand Terpilih</div>
        <div id="kpiBrand" class="big">‚Äì</div>
        <div class="note">Terhitung unik</div>
      </div>
      <div class="tile">
        <div>Records</div>
        <div id="kpiRows" class="big">‚Äì</div>
        <div class="note">Setelah filter</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card cols-12 split">
        <h3>Tren Mingguan: End Stock, FC, SP, SV</h3>
        <div class="row"><button id="btnTrendPng" class="ghost">PNG</button></div>
      </div>
      <div class="card cols-12"><div id="chartTrend" class="chart"></div></div>

      <div class="card cols-12 split">
        <h3>Deviasi: FC‚àíSV, SP‚àíSV, FC‚àíSP</h3>
        <div class="row"><button id="btnDevPng" class="ghost">PNG</button></div>
      </div>
      <div class="card cols-12"><div id="chartDev" class="chart small"></div></div>

      <div class="card cols-6 split">
        <h3>Top Brand (SV) ‚Äî Tertinggi</h3>
        <div class="row"><button id="btnTopCSV" class="ghost">CSV</button></div>
      </div>
      <div class="card cols-6 split">
        <h3>Top Brand (SV) ‚Äî Terendah</h3>
        <div class="row"><button id="btnLowCSV" class="ghost">CSV</button></div>
      </div>
      <div class="card cols-6">
        <table id="tblTop">
          <thead><tr><th>Brand</th><th class="right">SV</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card cols-6">
        <table id="tblLow">
          <thead><tr><th>Brand</th><th class="right">SV</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card cols-12 split">
        <h3>End Stock vs SV (Scatter)</h3>
        <div class="row"><button id="btnScatterPng" class="ghost">PNG</button></div>
      </div>
      <div class="card cols-12"><div id="chartScatter" class="chart small"></div></div>

      <div class="card cols-12">
        <h3>Insight Prediktif (Heuristik)</h3>
        <p class="note">Estimasi berbasis linear fit sederhana atas agregasi mingguan SV. Gunakan sebagai indikasi awal (¬±2 minggu).</p>
        <div id="predictBox"></div>
      </div>
    </div>

    <div class="footer">
      <div>create by: EJV Team ‚Ä¢ Auto-load TXT ‚Ä¢ GitHub Pages ready (V2)</div>
    </div>
  </div>

  <script type="module">
    /* =========================================================
       KONFIGURASI
    ========================================================= */
    const DATA_FILE = 'Data Penjualan.txt'; // jika diganti: 'data-penjualan.tsv'

    /* =========================================================
       UTIL
    ========================================================= */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = n => (Number.isFinite(n) ? n : 0).toLocaleString('id-ID');

    function normalizeHeader(h) {
      return String(h || '')
        .replace(/^\uFEFF/, '')       // BOM
        .toLowerCase()
        .replace(/\s+/g, '')
        .replace(/[()\-\/\.]/g, '')
        .replace(/thstick/g, 'thstick');
    }
    function toNum(v) {
      if (v == null) return 0;
      const s = String(v).trim().replace(/,/g, '');
      if (s === '' || s.toLowerCase() === 'na' || s.toLowerCase() === 'null') return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    const clean = s => String(s ?? '').trim();

    /* =========================================================
       PARSER TSV
    ========================================================= */
    function parseTSV(text) {
      text = text.replace(/^\uFEFF/, ''); // BOM awal file
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (!lines.length) return [];

      const rawHeaders = lines[0].split('\t').map(h => h.trim());
      const headersNorm = rawHeaders.map(normalizeHeader);
      const idx = Object.fromEntries(headersNorm.map((h, i) => [h, i]));

      const required = [
        'week','region','plant','area','brand','type',
        'openingstockpac','endstockpac','fcpac','sppac','svpac',
        'openingstockthstick','endstockthstick','fcthstick','spthstick','svthstick'
      ];
      const missing = required.filter(k => !(k in idx));
      if (missing.length) {
        console.warn('[TSV] Header tidak ditemukan:', missing);
        console.warn('[TSV] Header terdeteksi (mentah):', rawHeaders);
      }

      const out = [];
      for (let r = 1; r < lines.length; r++) {
        const cells = lines[r].split('\t');
        const g = key => {
          const i = idx[key];
          return i != null ? (cells[i] ?? '') : '';
        };
        const row = {
          Week: toNum(g('week')),
          Region: clean(g('region')),
          Plant: clean(g('plant')),
          Area: clean(g('area')),
          Brand: clean(g('brand')),
          Type: clean(g('type')),

          OS_Pac: toNum(g('openingstockpac')),
          ES_Pac: toNum(g('endstockpac')),
          FC_Pac: toNum(g('fcpac')),
          SP_Pac: toNum(g('sppac')),
          SV_Pac: toNum(g('svpac')),

          OS_TH: toNum(g('openingstockthstick')),
          ES_TH: toNum(g('endstockthstick')),
          FC_TH: toNum(g('fcthstick')),
          SP_TH: toNum(g('spthstick')),
          SV_TH: toNum(g('svthstick')),
        };

        row.Dev_FC_minus_SV = row.FC_Pac - row.SV_Pac;
        row.Dev_SP_minus_SV = row.SP_Pac - row.SV_Pac;
        row.Dev_FC_minus_SP = row.FC_Pac - row.SP_Pac;
        out.push(row);
      }
      return out;
    }

    /* =========================================================
       STATE
    ========================================================= */
    let RAW = [];
    let FILTER = {
      weekMin: null, weekMax: null,
      regions: [], areas: [], types: [], brands: [],
      unit: 'pac' // 'pac' | 'th'
    };

    /* =========================================================
       LOADER (robust untuk Pages & subfolder)
    ========================================================= */
    async function loadDataFromTXT() {
      const url = new URL(encodeURI('./' + DATA_FILE), window.location.href);
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`Gagal fetch ${url}: ${resp.status} ${resp.statusText}`);
      const text = await resp.text();
      return parseTSV(text);
    }

    /* =========================================================
       FILTER & SELECTION
    ========================================================= */
    function uniqSorted(arr) {
      return Array.from(new Set(arr)).filter(v => v !== '').sort((a,b) => (''+a).localeCompare(b));
    }

    function initFilters(data) {
      const weeks = uniqSorted(data.map(d => d.Week)).map(Number).filter(n=>Number.isFinite(n));
      $('#weekMin').value = Math.min(...weeks);
      $('#weekMax').value = Math.max(...weeks);
      FILTER.weekMin = Number($('#weekMin').value);
      FILTER.weekMax = Number($('#weekMax').value);

      const regions = uniqSorted(data.map(d => d.Region));
      const areas = uniqSorted(data.map(d => d.Area));
      const types = uniqSorted(data.map(d => d.Type));
      const brands = uniqSorted(data.map(d => d.Brand));

      function fill(sel, vals) {
        const el = $(sel);
        el.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        el.selectedIndex = -1; // default none (artinya semua)
      }
      fill('#regionSel', regions);
      fill('#areaSel', areas);
      fill('#typeSel', types);
      fill('#brandSel', brands);
      updateSelInfo();
    }

    function extractMulti(sel) {
      return Array.from($(sel).selectedOptions).map(o => o.value);
    }
    function updateSelInfo() {
      const rs = extractMulti('#regionSel');
      const as = extractMulti('#areaSel');
      const ts = extractMulti('#typeSel');
      const bs = extractMulti('#brandSel');
      $('#selInfo').textContent = [
        rs.length ? `Region: ${rs.length}` : null,
        as.length ? `Area: ${as.length}` : null,
        ts.length ? `Type: ${ts.length}` : null,
        bs.length ? `Brand: ${bs.length}` : null,
      ].filter(Boolean).join(' ‚Ä¢ ') || 'Semua';
    }

    function onApply() {
      FILTER.weekMin = Number($('#weekMin').value) || FILTER.weekMin;
      FILTER.weekMax = Number($('#weekMax').value) || FILTER.weekMax;
      FILTER.regions = extractMulti('#regionSel');
      FILTER.areas   = extractMulti('#areaSel');
      FILTER.types   = extractMulti('#typeSel');
      FILTER.brands  = extractMulti('#brandSel');
      updateSelInfo();
      renderAll();
    }
    function onReset() {
      ['regionSel','areaSel','typeSel','brandSel'].forEach(id => { $('#'+id).selectedIndex = -1; });
      const weeks = Array.from(new Set(RAW.map(d => d.Week))).map(Number).filter(Number.isFinite);
      $('#weekMin').value = Math.min(...weeks);
      $('#weekMax').value = Math.max(...weeks);
      FILTER = { weekMin: Number($('#weekMin').value), weekMax: Number($('#weekMax').value), regions:[], areas:[], types:[], brands:[], unit: FILTER.unit };
      updateSelInfo();
      renderAll();
    }

    function getUnitKey(base) { return FILTER.unit === 'pac' ? `${base}_Pac` : `${base}_TH`; }

    function applyFilter(data) {
      const {weekMin, weekMax, regions, areas, types, brands} = FILTER;
      return data.filter(d => {
        if (d.Week && (weekMin != null && d.Week < weekMin)) return false;
        if (d.Week && (weekMax != null && d.Week > weekMax)) return false;
        if (regions.length && !regions.includes(d.Region)) return false;
        if (areas.length && !areas.includes(d.Area)) return false;
        if (types.length && !types.includes(d.Type)) return false;
        if (brands.length && !brands.includes(d.Brand)) return false;
        return true;
      });
    }

    /* =========================================================
       AGREGASI, KPI, HEURISTIK
    ========================================================= */
    function groupByWeek(data) {
      const SV = getUnitKey('SV'), FC = getUnitKey('FC'), SP = getUnitKey('SP'), ES = getUnitKey('ES');
      const map = new Map();
      for (const r of data) {
        const w = r.Week || 0;
        if (!map.has(w)) map.set(w, {Week: w, SV:0, FC:0, SP:0, ES:0});
        const a = map.get(w);
        a.SV += r[SV] || 0;
        a.FC += r[FC] || 0;
        a.SP += r[SP] || 0;
        a.ES += r[ES] || 0;
      }
      const arr = Array.from(map.values()).sort((a,b)=>a.Week-b.Week);
      arr.forEach(d => {
        d.FC_minus_SV = d.FC - d.SV;
        d.SP_minus_SV = d.SP - d.SV;
        d.FC_minus_SP = d.FC - d.SP;
      });
      return arr;
    }

    function computeTopBrands(data, topN=10) {
      const SV = getUnitKey('SV');
      const map = new Map();
      for (const r of data) {
        const k = r.Brand || '(NA)';
        map.set(k, (map.get(k) || 0) + (r[SV] || 0));
      }
      const arr = Array.from(map.entries()).map(([Brand, SV])=>({Brand, SV}));
      const desc = arr.slice().sort((a,b)=>b.SV-a.SV);
      const asc  = arr.slice().filter(x => x.SV>0).sort((a,b)=>a.SV-b.SV);
      return { top: desc.slice(0, topN), low: asc.slice(0, topN) };
    }

    function computeKPIs(data) {
      const SV = getUnitKey('SV');
      const totalSV = data.reduce((s,r)=>s+(r[SV]||0),0);
      const weeks = Array.from(new Set(data.map(d=>d.Week))).filter(Number.isFinite);
      const avgSV = weeks.length ? totalSV / weeks.length : 0;
      const brands = new Set(data.map(d=>d.Brand).filter(Boolean));
      return { totalSV, avgSV, brandCount: brands.size, rows: data.length };
    }

    function linearFit(x, y) {
      const n = x.length;
      if (!n) return {a:0,b:0};
      let sx=0, sy=0, sxx=0, sxy=0;
      for (let i=0;i<n;i++){ sx+=x[i]; sy+=y[i]; sxx+=x[i]*x[i]; sxy+=x[i]*y[i]; }
      const b = (n*sxy - sx*sy) / Math.max(1e-9, (n*sxx - sx*sx));
      const a = (sy - b*sx) / n;
      return {a,b};
    }

    /* =========================================================
       RENDER (ECharts)
    ========================================================= */
    let trendChart, devChart, scatterChart;

    function renderTrend(weeks) {
      const x = weeks.map(d=>d.Week);
      const opt = {
        animation: true,
        animationDuration: 500,
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', valueFormatter: v => fmt(v) },
        legend: { data: ['End Stock','FC','SP','SV'], textStyle:{color:getComputedStyle(document.body).getPropertyValue('--fg')} },
        grid: { left: 40, right: 20, top: 30, bottom: 35 },
        xAxis: { type:'category', data: x, axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, axisLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        yAxis: { type:'value', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        series: [
          { name:'End Stock', type:'line', smooth:true, data: weeks.map(d=>d.ES) },
          { name:'FC', type:'line', smooth:true, data: weeks.map(d=>d.FC) },
          { name:'SP', type:'line', smooth:true, data: weeks.map(d=>d.SP) },
          { name:'SV', type:'line', smooth:true, data: weeks.map(d=>d.SV) },
        ]
      };
      trendChart = trendChart || echarts.init(document.getElementById('chartTrend'));
      trendChart.setOption(opt, true);
    }

    function renderDev(weeks) {
      const x = weeks.map(d=>d.Week);
      const opt = {
        animation: true,
        animationDuration: 500,
        backgroundColor: 'transparent',
        tooltip: { trigger:'axis', valueFormatter: v => fmt(v) },
        legend: { data: ['FC‚àíSV','SP‚àíSV','FC‚àíSP'], textStyle:{color:getComputedStyle(document.body).getPropertyValue('--fg')} },
        grid: { left: 40, right: 20, top: 30, bottom: 35 },
        xAxis: { type:'category', data:x, axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, axisLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        yAxis: { type:'value', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        series: [
          { name:'FC‚àíSV', type:'bar', data: weeks.map(d=>d.FC_minus_SV) },
          { name:'SP‚àíSV', type:'bar', data: weeks.map(d=>d.SP_minus_SV) },
          { name:'FC‚àíSP', type:'bar', data: weeks.map(d=>d.FC_minus_SP) },
        ]
      };
      devChart = devChart || echarts.init(document.getElementById('chartDev'));
      devChart.setOption(opt, true);
    }

    function renderScatter(rows) {
      const ES = getUnitKey('ES'), SV = getUnitKey('SV');
      const data = rows.map(r => [r[ES] || 0, r[SV] || 0, r.Brand || '']).filter(p => (p[0]+p[1])>0);
      const opt = {
        animation: true,
        animationDuration: 500,
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'item',
          formatter: p => {
            const [x,y,brand] = p.data;
            return `Brand: <b>${brand}</b><br>ES: ${fmt(x)} ‚Ä¢ SV: ${fmt(y)}`;
          }
        },
        grid: { left: 50, right: 20, top: 20, bottom: 40 },
        xAxis: { type:'value', name:'End Stock', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        yAxis: { type:'value', name:'SV', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        series: [{ type:'scatter', symbolSize: 8, data, itemStyle:{ color:getComputedStyle(document.body).getPropertyValue('--accent') } }]
      };
      scatterChart = scatterChart || echarts.init(document.getElementById('chartScatter'));
      scatterChart.setOption(opt, true);
    }

    function renderTables(top, low) {
      const tbodyTop = $('#tblTop tbody');
      const tbodyLow = $('#tblLow tbody');
      tbodyTop.innerHTML = top.map(r => `<tr><td>${r.Brand}</td><td class="right">${fmt(r.SV)}</td></tr>`).join('');
      tbodyLow.innerHTML = low.map(r => `<tr><td>${r.Brand}</td><td class="right">${fmt(r.SV)}</td></tr>`).join('');
    }

    function renderKPIs(k) {
      $('#kpiSV').textContent = fmt(k.totalSV);
      $('#kpiSVAvg').textContent = fmt(Math.round(k.avgSV));
      $('#kpiBrand').textContent = fmt(k.brandCount);
      $('#kpiRows').textContent = fmt(k.rows);
    }

    function renderPredict(weeks) {
      const x = weeks.map(d=>d.Week);
      const y = weeks.map(d=>d.SV);
      if (!x.length) { $('#predictBox').innerHTML = '<div class="note">Tidak ada data.</div>'; return; }
      const {a,b} = linearFit(x,y);
      const lastW = x[x.length-1];
      const next1 = Math.round(a + b*(lastW+1));
      const next2 = Math.round(a + b*(lastW+2));
      $('#predictBox').innerHTML = `
        <div class="row">
          <span class="chip">Model</span>
          <span>a = ${fmt(Math.round(a))}</span>
          <span>‚Ä¢ b = ${fmt(Math.round(b))}</span>
        </div>
        <p>Perkiraan SV minggu ke-<b>${lastW+1}</b>: <b>${fmt(next1)}</b>
           &nbsp;‚Ä¢&nbsp; minggu ke-<b>${lastW+2}</b>: <b>${fmt(next2)}</b></p>
        <p class="note">Catatan: linear fit sederhana; gunakan sebagai indikasi awal (¬±2 minggu).</p>
      `;
    }

    function renderAll() {
      const filtered = applyFilter(RAW);
      const gw = groupByWeek(filtered);
      renderTrend(gw);
      renderDev(gw);
      renderScatter(filtered);
      const {top, low} = computeTopBrands(filtered, 10);
      renderTables(top, low);
      renderKPIs(computeKPIs(filtered));
      renderPredict(gw);
      $('#status').textContent = `Siap ‚Ä¢ ${fmt(filtered.length)} baris (Unit: ${FILTER.unit === 'pac' ? 'Pack' : 'TH Stick'})`;
    }

    /* =========================================================
       EXPORT
    ========================================================= */
    function chartToPNG(chart, name='chart.png') {
      if (!chart) return;
      const url = chart.getDataURL({ pixelRatio: 2, backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg').trim() });
      fetch(url).then(r => r.blob()).then(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
      });
    }
    function download(name, mime, content) {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1200);
    }
    function exportCSVFiltered() {
      const rows = applyFilter(RAW);
      const sep = ',';
      const headers = ['Week','Region','Plant','Area','Brand','Type',
        getUnitKey('OS'), getUnitKey('ES'), getUnitKey('FC'), getUnitKey('SP'), getUnitKey('SV')];
      const mapKey = k => ({
        'OS_Pac':'Opening Stock (Pac)', 'ES_Pac':'End Stock (Pac)', 'FC_Pac':'FC (Pac)', 'SP_Pac':'SP (Pac)', 'SV_Pac':'SV (Pac)',
        'OS_TH':'Opening Stock (TH Stick)','ES_TH':'End Stock (TH Stick)','FC_TH':'FC (TH Stick)','SP_TH':'SP (TH Stick)','SV_TH':'SV (TH Stick)'
      }[k] || k);
      const headerHuman = ['Week','Region','Plant','Area','Brand','Type', ...headers.slice(6).map(mapKey)];
      const lines = [headerHuman.join(sep)];
      for (const r of rows) {
        const vals = [
          r.Week, r.Region, r.Plant, r.Area, r.Brand, r.Type,
          r[headers[6]]||0, r[headers[7]]||0, r[headers[8]]||0, r[headers[9]]||0, r[headers[10]]||0
        ];
        lines.push(vals.join(sep));
      }
      download(`Filtered_${FILTER.unit.toUpperCase()}.csv`, 'text/csv;charset=utf-8', lines.join('\n'));
    }

    /* =========================================================
       THEME & EVENTS
    ========================================================= */
    function toggleTheme() {
      document.body.classList.toggle('light');
      // repaint charts
      trendChart && trendChart.resize();
      devChart && devChart.resize();
      scatterChart && scatterChart.resize();
    }

    /* =========================================================
       BOOTSTRAP (guard agar tidak double-run)
    ========================================================= */
    if (!window.__TSV_BOOTSTRAPPED__) {
      window.__TSV_BOOTSTRAPPED__ = true;
      document.addEventListener('DOMContentLoaded', bootstrap, { once: true });
    }

    async function bootstrap() {
      const $status = $('#status') || null;
      try {
        $status && ($status.textContent = 'Memuat Data Penjualan (TXT)‚Ä¶');
        RAW = await loadDataFromTXT();

        // Diagnostik aman
        console.log('[TSV] tipe data:', Object.prototype.toString.call(RAW));
        if (Array.isArray(RAW)) console.log('[TSV] Contoh 3 baris:', RAW.slice(0,3));

        // Unit toggle
        $$('input[name="unit"]').forEach(r => r.addEventListener('change', e => {
          FILTER.unit = e.target.value === 'th' ? 'th' : 'pac';
          renderAll();
        }));

        // Filter actions
        $('#applyBtn').addEventListener('click', onApply);
        $('#resetBtn').addEventListener('click', onReset);
        ['regionSel','areaSel','typeSel','brandSel'].forEach(id => {
          $('#'+id).addEventListener('change', updateSelInfo);
        });

        // Export
        $('#btnExportCSV').addEventListener('click', exportCSVFiltered);
        $('#btnTopCSV').addEventListener('click', () => {
          const {top} = computeTopBrands(applyFilter(RAW));
          download('TopBrand_SV.csv','text/csv;charset=utf-8', ['Brand,SV', ...top.map(p=>`${p.Brand},${p.SV}`)].join('\n'));
        });
        $('#btnLowCSV').addEventListener('click', () => {
          const {low} = computeTopBrands(applyFilter(RAW));
          download('LowBrand_SV.csv','text/csv;charset=utf-8', ['Brand,SV', ...low.map(p=>`${p.Brand},${p.SV}`)].join('\n'));
        });
        $('#btnTrendPng').addEventListener('click', ()=>chartToPNG(trendChart, 'Trend.png'));
        $('#btnDevPng').addEventListener('click', ()=>chartToPNG(devChart, 'Deviasi.png'));
        $('#btnScatterPng').addEventListener('click', ()=>chartToPNG(scatterChart, 'Scatter_ES_vs_SV.png'));

        // Theme & resize
        $('#themeBtn').addEventListener('click', toggleTheme);
        window.addEventListener('resize', () => {
          trendChart && trendChart.resize();
          devChart && devChart.resize();
          scatterChart && scatterChart.resize();
        });

        // Init filter & render
        initFilters(RAW);
        renderAll();
      } catch (err) {
        console.error('[TSV] Error loader:', err);
        $status && ($status.textContent = 'Gagal memuat data. Pastikan file data ada & lihat konsol.');
      }
    }

    // Hooks error global (opsional, berguna saat debug di Pages)
    window.addEventListener('error', e => console.error('[GLOBAL ERROR]', e.message, e.error));
    window.addEventListener('unhandledrejection', e => console.error('[PROMISE REJECTION]', e.reason));
  </script>
</body>
</html>
