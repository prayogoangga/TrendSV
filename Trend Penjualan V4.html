<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Penjualan ‚Äî Mingguan (V2)</title>
  <meta name="description" content="Dashboard penjualan mingguan: tren, deviasi, top brand, scatter stok vs penjualan. Auto-load dari Data Penjualan.txt" />
  <script src="https://cdn.jsdelivr.net"></script>
  <script src="https://unpkg.com"></script>
  <!-- ECharts 5: CDN -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- Charts & Excel Parser -->
   <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Multi-select dengan search -->
 <link href="https://cdn.jsdelivr.net/npm/choicesces.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Font & Styles -->
<link href="https://fonts.googleapis.comink" rel="preconnect">
<link href="https://fonts.googleapis.com/css2?family=00;600;700&display=swap"/>
  
 <style>
  :root {
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --border:#1f2937; --plotBg:#0b1220; --grid:#1f2937; --accent:#3b82f6;
  }
  :root[data-theme="light"] {
    --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --text:#0f172a;
    --border:#e2e8f0; --plotBg:#ffffff; --grid:#e2e8f0; --accent:#2563eb;
  }

  * { box-sizing:border-box; }
  body {
    margin:0;
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto;
    background:var(--bg);
    color:var(--text);
  }
  header {
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    background:color-mix(in oklab, var(--bg), black 5%);
  }
  h1 { font-size:18px; margin:0 0 4px; }
  .wrap { display:grid; grid-template-columns:320px 1fr; gap:14px; padding:12px; }
  .panel {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    position:sticky;
    top:12px;
    height:calc(100vh - 40px);
    overflow:auto;
  }
  .panel h2 { font-size:14px; margin:6px 0 10px; color:var(--muted); }
  .field { margin-bottom:10px; }
  label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  input[type=number], select, .btn {
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--bg);
    color:var(--text);
  }
  .row { display:flex; gap:8px; }
  .seg { display:flex; gap:6px; }
  .seg button {
    flex:1;
    padding:8px 10px;
    background:var(--bg);
    border:1px solid var(--border);
    color:var(--text);
    border-radius:8px;
    cursor:pointer;
  }
  .seg button.active { outline:2px solid var(--accent); outline-offset:0; }
  .content { display:flex; flex-direction:column; gap:14px; }
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
  }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .summary p { margin:4px 0; color:var(--text); }
  .muted { color:var(--muted); }
  .badge {
    display:inline-block;
    padding:2px 6px;
    font-size:11px;
    border-radius:9999px;
    background:color-mix(in oklab, var(--card), black 7%);
    color:var(--text);
    border:1px solid var(--border);
  }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid var(--border); font-size:12px; }
  th { text-align:left; color:var(--text); }
  .btn { cursor:pointer; }
  .head-actions { display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .btn-inline {
    padding:8px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    cursor:pointer;
  }
  @media (max-width:980px) {
    .wrap { grid-template-columns:1fr; }
    .panel { position:static; height:auto; }
    .grid2 { grid-template-columns:1fr; }
  }
  
/* Panel filter yang bisa di-hide */
details.filter{
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 8px;
  background:var(--bg);
  margin-bottom:8px;
}
details.filter > summary{
  cursor:pointer;
  list-style:none;
  display:flex; align-items:center; justify-content:space-between;
  color:var(--muted);
}
details.filter[open] > summary{ color:var(--text); }
details.filter > summary::-webkit-details-marker { display:none; }
.summary-chip{ font-size:11px; color:var(--muted); }

/* Compact Choices.js */
.choices[data-type*="select-multiple"] .choices__inner{
  padding:4px 6px; min-height:36px; background:var(--bg); border-color:var(--border);
}
.choices__list--multiple .choices__item{
  margin:2px 2px; padding:2px 6px; font-size:12px; border-radius:9999px;
}
.choices__list--dropdown{
  max-height:220px; overflow:auto; background:var(--card); border-color:var(--border);
}
.choices__list--dropdown .choices__item--selectable{ font-size:13px; }

/* Warna untuk angka naik/turun */
.pos{ color:#16a34a; }      /* hijau */
.neg{ color:#ef4444; }      /* merah */
.neutral{ color:var(--muted); } /* abu-abu */

/* ===== TICKER ===== */
.ticker{
  border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);
  background: color-mix(in oklab, var(--card), black 6%);
  overflow:hidden;
}
.ticker__track{
  white-space:nowrap;
  will-change: transform;
  display:inline-block;
  padding:8px 0;
  /* durasi scroll akan di-set via style inline --dur (detik) */
  animation: tickerAnim var(--dur, 30s) linear infinite;
}
.ticker__item{ margin-right:28px; font-size:13px }
.ticker__wk{ color:var(--muted); margin-right:6px }
@keyframes tickerAnim {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}
.ticker:hover .ticker__track{ animation-play-state: paused; }

/* ===== Collapsible filter + checkbox list ===== */
details.filter{
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 8px;
  background:var(--bg);
  margin-bottom:8px;
}
details.filter > summary{
  cursor:pointer; list-style:none;
  display:flex; align-items:center; justify-content:space-between; color:var(--muted);
}
details.filter[open] > summary{ color:var(--text); }
details.filter > summary::-webkit-details-marker{ display:none; }
.summary-chip{ font-size:11px; color:var(--muted); }

.filter-search{
  width:100%; padding:8px 10px; margin:8px 0;
  border-radius:8px; border:1px solid var(--border);
  background:var(--bg); color:var(--text);
}
.filter-list{
  max-height:220px; overflow:auto;
  border:1px dashed var(--border); border-radius:8px; padding:6px;
  background:var(--card);
}
.filter-item{
  display:flex; align-items:center; gap:8px; padding:4px 6px; border-radius:8px;
}
.filter-item:hover{ background: color-mix(in oklab, var(--card), var(--text) 8%) }
.filter-item input{ width:16px; height:16px }

/* Untuk kemungkinan radio (single-select) ‚Äî siap pakai bila diperlukan */
.filter-item input[type="radio"]{ accent-color: #3b82f6; }
.filter-item input[type="checkbox"]{ accent-color: #3b82f6; }

/* ===== Warna angka naik/turun ===== */
.pos     { color:#16a34a !important; }   /* hijau (naik) */
.neg     { color:#ef4444 !important; }   /* merah (turun) */
.neutral { color:var(--muted) !important; }

/* Header sticky */
header{
  position: sticky;
  top: 0;
  z-index: 1000; /* pastikan di atas chart/konten */
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  /* Warna latar pakai var yang sudah ada di tema */
  background: color-mix(in oklab, var(--bg), black 5%);
}

/* ========== Tooltip Colors ========== */
:root {
  /* Mode gelap */
  --tooltipBg:    var(--card);   /* latar tooltip (gelap) */
  --tooltipText:  var(--text);   /* teks tooltip */
  --tooltipLine:  var(--border); /* garis tepi tooltip */
}
:root[data-theme="light"] {
  /* Mode terang */
  --tooltipBg:    var(--card);   /* biasanya putih */
  --tooltipText:  var(--text);   /* teks gelap */
  --tooltipLine:  var(--border); /* garis tepi tooltip */
}

  </style>
</head>

  
<body>
<header>
  <div class="head-actions">
    <div>
      <h1>Dashboard Penjualan ‚Äî Mingguan</h1>
      <div class="muted">Y: End Stock, FC, SP, SV ‚Ä¢ X: Week ‚Ä¢ Filter: Week, Region, Area, Type, Brand ‚Ä¢ Unit: Pack / TH Stick</div>
    </div>
    <div>
      <button id="themeToggle" class="btn-inline" title="Toggle tema">üåô/‚òÄÔ∏è</button>
    </div>
  </div>
</header>

<!-- TICKER: menampilkan perubahan week-over-week (SV, FC, SP, ES) -->
<div id="ticker" class="ticker">
  <div id="tickerTrack" class="ticker__track"></div>
</div>

<div class="wrap">
  <!-- Sidebar / Control Panel -->
  <aside class="panel">
    <h2>Data</h2>
    <div class="field">
      <input type="file" id="fileInput" accept=".xlsx" class="btn"/>
      <div class="muted" style="font-size:11px;margin-top:6px">Klik ‚ÄúMuat Excel (.xlsx)‚Äù lalu pilih <b>Data Penjualan.xlsx</b>.</div>
    </div>

<h2>Filter</h2>

<div class="field">
  <label>Rentang Week</label>
  <div class="row">
    <input type="number" id="wmin" value="1"/>
    <input type="number" id="wmax" value="52"/>
  </div>
  <div class="muted" id="wkRangeText" style="margin-top:4px">(Week ‚Ä¶)</div>
</div>

<!-- Region -->
<details class="filter" id="secRegion">
  <summary><span>Region</span><span class="summary-chip" id="chipRegion">Semua</span></summary>
  <input id="srchRegion" class="filter-search" type="text" placeholder="Cari Region‚Ä¶">
  <div id="listRegion" class="filter-list"></div>
</details>

<!-- Area -->
<details class="filter" id="secArea">
  <summary><span>Area</span><span class="summary-chip" id="chipArea">Semua</span></summary>
  <input id="srchArea" class="filter-search" type="text" placeholder="Cari Area‚Ä¶">
  <div id="listArea" class="filter-list"></div>
</details>

<!-- Type -->
<details class="filter" id="secType">
  <summary><span>Type</span><span class="summary-chip" id="chipType">Semua</span></summary>
  <input id="srchType" class="filter-search" type="text" placeholder="Cari Type‚Ä¶">
  <div id="listType" class="filter-list"></div>
</details>

<!-- Brand -->
<details class="filter" id="secBrand">
  <summary><span>Brand</span><span class="summary-chip" id="chipBrand">Semua</span></summary>
  <input id="srchBrand" class="filter-search" type="text" placeholder="Cari Brand‚Ä¶">
  <div id="listBrand" class="filter-list"></div>
</details>

<div class="field" style="margin-top:10px">
  <label>Unit</label>
  <div class="seg">
    <button id="unitPack" class="active">Pack</button>
    <button id="unitStick">TH Stick</button>
  </div>
</div>

<div class="field">
  <button id="reset" class="btn" style="width:100%">Reset Filter</button>
</div>
<div class="muted" style="font-size:11px">
  Tip: klik judul untuk membuka/menutup filter. Search mendukung multi-pick dengan checkbox.
</div>


  </aside>

  <!-- Content -->
  <main class="content">
    <section class="card">
      <h3 style="margin:0 0 6px">Tren Mingguan: End Stock, FC, SP, SV</h3>
      <div id="chart_main" style="height:420px"></div>
    </section>

    <section class="grid2">
      <div class="card">
        <h3 style="margin:0 0 6px">Deviasi: FC‚àíSV, SP‚àíSV, FC‚àíSP</h3>
        <div id="chart_dev" style="height:340px"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">Ringkasan Tren</h3>
        <div id="summary" class="summary"><p class="muted">Muat Excel untuk melihat ringkasan.</p></div>

        <h3 style="margin:16px 0 6px">Top Brand (SV)</h3>
        <div class="grid2">
          <div>
            <div class="badge">Tertinggi</div>
            <table id="top_hi"><thead><tr><th>Brand</th><th>SV</th></tr></thead><tbody></tbody></table>
          </div>
          <div>
            <div class="badge" style="background:#2a1818;color:#fecaca;border-color:#7f1d1d">Terendah</div>
            <table id="top_lo"><thead><tr><th>Brand</th><th>SV</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">End Stock vs SV (Stok vs Penjualan)</h3>
      <div id="chart_es_sv" style="height:380px"></div>
      <div id="stockSalesNotes" class="muted" style="margin-top:8px;font-size:13px"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">Insight Prediktif (Heuristik)</h3>
      <div id="forecastBox" class="summary"><p class="muted">Estimasi berbasis linear fit sederhana, gunakan sebagai indikasi awal (¬±2 minggu).</p></div>
    </section>
  </main>
</div>

  <script type="module">
    /* =========================================================
       KONFIGURASI
    ========================================================= */
    const DATA_FILE = 'Data Penjualan.txt'; // jika diganti: 'data-penjualan.tsv'

    /* =========================================================
       UTIL
    ========================================================= */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = n => (Number.isFinite(n) ? n : 0).toLocaleString('id-ID');

    function normalizeHeader(h) {
      return String(h || '')
        .replace(/^\uFEFF/, '')       // BOM
        .toLowerCase()
        .replace(/\s+/g, '')
        .replace(/[()\-\/\.]/g, '')
        .replace(/thstick/g, 'thstick');
    }
    function toNum(v) {
      if (v == null) return 0;
      const s = String(v).trim().replace(/,/g, '');
      if (s === '' || s.toLowerCase() === 'na' || s.toLowerCase() === 'null') return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    const clean = s => String(s ?? '').trim();

    /* =========================================================
       PARSER TSV
    ========================================================= */
    function parseTSV(text) {
      text = text.replace(/^\uFEFF/, ''); // BOM awal file
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (!lines.length) return [];

      const rawHeaders = lines[0].split('\t').map(h => h.trim());
      const headersNorm = rawHeaders.map(normalizeHeader);
      const idx = Object.fromEntries(headersNorm.map((h, i) => [h, i]));

      const required = [
        'week','region','plant','area','brand','type',
        'openingstockpac','endstockpac','fcpac','sppac','svpac',
        'openingstockthstick','endstockthstick','fcthstick','spthstick','svthstick'
      ];
      const missing = required.filter(k => !(k in idx));
      if (missing.length) {
        console.warn('[TSV] Header tidak ditemukan:', missing);
        console.warn('[TSV] Header terdeteksi (mentah):', rawHeaders);
      }

      const out = [];
      for (let r = 1; r < lines.length; r++) {
        const cells = lines[r].split('\t');
        const g = key => {
          const i = idx[key];
          return i != null ? (cells[i] ?? '') : '';
        };
        const row = {
          Week: toNum(g('week')),
          Region: clean(g('region')),
          Plant: clean(g('plant')),
          Area: clean(g('area')),
          Brand: clean(g('brand')),
          Type: clean(g('type')),

          OS_Pac: toNum(g('openingstockpac')),
          ES_Pac: toNum(g('endstockpac')),
          FC_Pac: toNum(g('fcpac')),
          SP_Pac: toNum(g('sppac')),
          SV_Pac: toNum(g('svpac')),

          OS_TH: toNum(g('openingstockthstick')),
          ES_TH: toNum(g('endstockthstick')),
          FC_TH: toNum(g('fcthstick')),
          SP_TH: toNum(g('spthstick')),
          SV_TH: toNum(g('svthstick')),
        };

        row.Dev_FC_minus_SV = row.FC_Pac - row.SV_Pac;
        row.Dev_SP_minus_SV = row.SP_Pac - row.SV_Pac;
        row.Dev_FC_minus_SP = row.FC_Pac - row.SP_Pac;
        out.push(row);
      }
      return out;
    }

    /* =========================================================
       STATE
    ========================================================= */
    let RAW = [];
    let FILTER = {
      weekMin: null, weekMax: null,
      regions: [], areas: [], types: [], brands: [],
      unit: 'pac' // 'pac' | 'th'
    };

    /* =========================================================
       LOADER (robust untuk Pages & subfolder)
    ========================================================= */
    async function loadDataFromTXT() {
      const url = new URL(encodeURI('./' + DATA_FILE), window.location.href);
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`Gagal fetch ${url}: ${resp.status} ${resp.statusText}`);
      const text = await resp.text();
      return parseTSV(text);
    }

    /* =========================================================
       FILTER & SELECTION
    ========================================================= */
    function uniqSorted(arr) {
      return Array.from(new Set(arr)).filter(v => v !== '').sort((a,b) => (''+a).localeCompare(b));
    }

    function initFilters(data) {
      const weeks = uniqSorted(data.map(d => d.Week)).map(Number).filter(n=>Number.isFinite(n));
      $('#weekMin').value = Math.min(...weeks);
      $('#weekMax').value = Math.max(...weeks);
      FILTER.weekMin = Number($('#weekMin').value);
      FILTER.weekMax = Number($('#weekMax').value);

      const regions = uniqSorted(data.map(d => d.Region));
      const areas = uniqSorted(data.map(d => d.Area));
      const types = uniqSorted(data.map(d => d.Type));
      const brands = uniqSorted(data.map(d => d.Brand));

      function fill(sel, vals) {
        const el = $(sel);
        el.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        el.selectedIndex = -1; // default none (artinya semua)
      }
      fill('#regionSel', regions);
      fill('#areaSel', areas);
      fill('#typeSel', types);
      fill('#brandSel', brands);
      updateSelInfo();
    }

    function extractMulti(sel) {
      return Array.from($(sel).selectedOptions).map(o => o.value);
    }
    function updateSelInfo() {
      const rs = extractMulti('#regionSel');
      const as = extractMulti('#areaSel');
      const ts = extractMulti('#typeSel');
      const bs = extractMulti('#brandSel');
      $('#selInfo').textContent = [
        rs.length ? `Region: ${rs.length}` : null,
        as.length ? `Area: ${as.length}` : null,
        ts.length ? `Type: ${ts.length}` : null,
        bs.length ? `Brand: ${bs.length}` : null,
      ].filter(Boolean).join(' ‚Ä¢ ') || 'Semua';
    }

    function onApply() {
      FILTER.weekMin = Number($('#weekMin').value) || FILTER.weekMin;
      FILTER.weekMax = Number($('#weekMax').value) || FILTER.weekMax;
      FILTER.regions = extractMulti('#regionSel');
      FILTER.areas   = extractMulti('#areaSel');
      FILTER.types   = extractMulti('#typeSel');
      FILTER.brands  = extractMulti('#brandSel');
      updateSelInfo();
      renderAll();
    }
    function onReset() {
      ['regionSel','areaSel','typeSel','brandSel'].forEach(id => { $('#'+id).selectedIndex = -1; });
      const weeks = Array.from(new Set(RAW.map(d => d.Week))).map(Number).filter(Number.isFinite);
      $('#weekMin').value = Math.min(...weeks);
      $('#weekMax').value = Math.max(...weeks);
      FILTER = { weekMin: Number($('#weekMin').value), weekMax: Number($('#weekMax').value), regions:[], areas:[], types:[], brands:[], unit: FILTER.unit };
      updateSelInfo();
      renderAll();
    }

    function getUnitKey(base) { return FILTER.unit === 'pac' ? `${base}_Pac` : `${base}_TH`; }

    function applyFilter(data) {
      const {weekMin, weekMax, regions, areas, types, brands} = FILTER;
      return data.filter(d => {
        if (d.Week && (weekMin != null && d.Week < weekMin)) return false;
        if (d.Week && (weekMax != null && d.Week > weekMax)) return false;
        if (regions.length && !regions.includes(d.Region)) return false;
        if (areas.length && !areas.includes(d.Area)) return false;
        if (types.length && !types.includes(d.Type)) return false;
        if (brands.length && !brands.includes(d.Brand)) return false;
        return true;
      });
    }

    /* =========================================================
       AGREGASI, KPI, HEURISTIK
    ========================================================= */
    function groupByWeek(data) {
      const SV = getUnitKey('SV'), FC = getUnitKey('FC'), SP = getUnitKey('SP'), ES = getUnitKey('ES');
      const map = new Map();
      for (const r of data) {
        const w = r.Week || 0;
        if (!map.has(w)) map.set(w, {Week: w, SV:0, FC:0, SP:0, ES:0});
        const a = map.get(w);
        a.SV += r[SV] || 0;
        a.FC += r[FC] || 0;
        a.SP += r[SP] || 0;
        a.ES += r[ES] || 0;
      }
      const arr = Array.from(map.values()).sort((a,b)=>a.Week-b.Week);
      arr.forEach(d => {
        d.FC_minus_SV = d.FC - d.SV;
        d.SP_minus_SV = d.SP - d.SV;
        d.FC_minus_SP = d.FC - d.SP;
      });
      return arr;
    }

    function computeTopBrands(data, topN=10) {
      const SV = getUnitKey('SV');
      const map = new Map();
      for (const r of data) {
        const k = r.Brand || '(NA)';
        map.set(k, (map.get(k) || 0) + (r[SV] || 0));
      }
      const arr = Array.from(map.entries()).map(([Brand, SV])=>({Brand, SV}));
      const desc = arr.slice().sort((a,b)=>b.SV-a.SV);
      const asc  = arr.slice().filter(x => x.SV>0).sort((a,b)=>a.SV-b.SV);
      return { top: desc.slice(0, topN), low: asc.slice(0, topN) };
    }

    function computeKPIs(data) {
      const SV = getUnitKey('SV');
      const totalSV = data.reduce((s,r)=>s+(r[SV]||0),0);
      const weeks = Array.from(new Set(data.map(d=>d.Week))).filter(Number.isFinite);
      const avgSV = weeks.length ? totalSV / weeks.length : 0;
      const brands = new Set(data.map(d=>d.Brand).filter(Boolean));
      return { totalSV, avgSV, brandCount: brands.size, rows: data.length };
    }

    function linearFit(x, y) {
      const n = x.length;
      if (!n) return {a:0,b:0};
      let sx=0, sy=0, sxx=0, sxy=0;
      for (let i=0;i<n;i++){ sx+=x[i]; sy+=y[i]; sxx+=x[i]*x[i]; sxy+=x[i]*y[i]; }
      const b = (n*sxy - sx*sy) / Math.max(1e-9, (n*sxx - sx*sx));
      const a = (sy - b*sx) / n;
      return {a,b};
    }

    /* =========================================================
       RENDER (ECharts)
    ========================================================= */
    let trendChart, devChart, scatterChart;

    function renderTrend(weeks) {
      const x = weeks.map(d=>d.Week);
      const opt = {
        animation: true,
        animationDuration: 500,
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', valueFormatter: v => fmt(v) },
        legend: { data: ['End Stock','FC','SP','SV'], textStyle:{color:getComputedStyle(document.body).getPropertyValue('--fg')} },
        grid: { left: 40, right: 20, top: 30, bottom: 35 },
        xAxis: { type:'category', data: x, axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, axisLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        yAxis: { type:'value', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        series: [
          { name:'End Stock', type:'line', smooth:true, data: weeks.map(d=>d.ES) },
          { name:'FC', type:'line', smooth:true, data: weeks.map(d=>d.FC) },
          { name:'SP', type:'line', smooth:true, data: weeks.map(d=>d.SP) },
          { name:'SV', type:'line', smooth:true, data: weeks.map(d=>d.SV) },
        ]
      };
      trendChart = trendChart || echarts.init(document.getElementById('chartTrend'));
      trendChart.setOption(opt, true);
    }

    function renderDev(weeks) {
      const x = weeks.map(d=>d.Week);
      const opt = {
        animation: true,
        animationDuration: 500,
        backgroundColor: 'transparent',
        tooltip: { trigger:'axis', valueFormatter: v => fmt(v) },
        legend: { data: ['FC‚àíSV','SP‚àíSV','FC‚àíSP'], textStyle:{color:getComputedStyle(document.body).getPropertyValue('--fg')} },
        grid: { left: 40, right: 20, top: 30, bottom: 35 },
        xAxis: { type:'category', data:x, axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, axisLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        yAxis: { type:'value', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        series: [
          { name:'FC‚àíSV', type:'bar', data: weeks.map(d=>d.FC_minus_SV) },
          { name:'SP‚àíSV', type:'bar', data: weeks.map(d=>d.SP_minus_SV) },
          { name:'FC‚àíSP', type:'bar', data: weeks.map(d=>d.FC_minus_SP) },
        ]
      };
      devChart = devChart || echarts.init(document.getElementById('chartDev'));
      devChart.setOption(opt, true);
    }

    function renderScatter(rows) {
      const ES = getUnitKey('ES'), SV = getUnitKey('SV');
      const data = rows.map(r => [r[ES] || 0, r[SV] || 0, r.Brand || '']).filter(p => (p[0]+p[1])>0);
      const opt = {
        animation: true,
        animationDuration: 500,
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'item',
          formatter: p => {
            const [x,y,brand] = p.data;
            return `Brand: <b>${brand}</b><br>ES: ${fmt(x)} ‚Ä¢ SV: ${fmt(y)}`;
          }
        },
        grid: { left: 50, right: 20, top: 20, bottom: 40 },
        xAxis: { type:'value', name:'End Stock', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        yAxis: { type:'value', name:'SV', axisLabel:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, splitLine:{lineStyle:{color:getComputedStyle(document.body).getPropertyValue('--border')}} },
        series: [{ type:'scatter', symbolSize: 8, data, itemStyle:{ color:getComputedStyle(document.body).getPropertyValue('--accent') } }]
      };
      scatterChart = scatterChart || echarts.init(document.getElementById('chartScatter'));
      scatterChart.setOption(opt, true);
    }

    function renderTables(top, low) {
      const tbodyTop = $('#tblTop tbody');
      const tbodyLow = $('#tblLow tbody');
      tbodyTop.innerHTML = top.map(r => `<tr><td>${r.Brand}</td><td class="right">${fmt(r.SV)}</td></tr>`).join('');
      tbodyLow.innerHTML = low.map(r => `<tr><td>${r.Brand}</td><td class="right">${fmt(r.SV)}</td></tr>`).join('');
    }

    function renderKPIs(k) {
      $('#kpiSV').textContent = fmt(k.totalSV);
      $('#kpiSVAvg').textContent = fmt(Math.round(k.avgSV));
      $('#kpiBrand').textContent = fmt(k.brandCount);
      $('#kpiRows').textContent = fmt(k.rows);
    }

    function renderPredict(weeks) {
      const x = weeks.map(d=>d.Week);
      const y = weeks.map(d=>d.SV);
      if (!x.length) { $('#predictBox').innerHTML = '<div class="note">Tidak ada data.</div>'; return; }
      const {a,b} = linearFit(x,y);
      const lastW = x[x.length-1];
      const next1 = Math.round(a + b*(lastW+1));
      const next2 = Math.round(a + b*(lastW+2));
      $('#predictBox').innerHTML = `
        <div class="row">
          <span class="chip">Model</span>
          <span>a = ${fmt(Math.round(a))}</span>
          <span>‚Ä¢ b = ${fmt(Math.round(b))}</span>
        </div>
        <p>Perkiraan SV minggu ke-<b>${lastW+1}</b>: <b>${fmt(next1)}</b>
           &nbsp;‚Ä¢&nbsp; minggu ke-<b>${lastW+2}</b>: <b>${fmt(next2)}</b></p>
        <p class="note">Catatan: linear fit sederhana; gunakan sebagai indikasi awal (¬±2 minggu).</p>
      `;
    }

    function renderAll() {
      const filtered = applyFilter(RAW);
      const gw = groupByWeek(filtered);
      renderTrend(gw);
      renderDev(gw);
      renderScatter(filtered);
      const {top, low} = computeTopBrands(filtered, 10);
      renderTables(top, low);
      renderKPIs(computeKPIs(filtered));
      renderPredict(gw);
      $('#status').textContent = `Siap ‚Ä¢ ${fmt(filtered.length)} baris (Unit: ${FILTER.unit === 'pac' ? 'Pack' : 'TH Stick'})`;
    }

    /* =========================================================
       EXPORT
    ========================================================= */
    function chartToPNG(chart, name='chart.png') {
      if (!chart) return;
      const url = chart.getDataURL({ pixelRatio: 2, backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg').trim() });
      fetch(url).then(r => r.blob()).then(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
      });
    }
    function download(name, mime, content) {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1200);
    }
    function exportCSVFiltered() {
      const rows = applyFilter(RAW);
      const sep = ',';
      const headers = ['Week','Region','Plant','Area','Brand','Type',
        getUnitKey('OS'), getUnitKey('ES'), getUnitKey('FC'), getUnitKey('SP'), getUnitKey('SV')];
      const mapKey = k => ({
        'OS_Pac':'Opening Stock (Pac)', 'ES_Pac':'End Stock (Pac)', 'FC_Pac':'FC (Pac)', 'SP_Pac':'SP (Pac)', 'SV_Pac':'SV (Pac)',
        'OS_TH':'Opening Stock (TH Stick)','ES_TH':'End Stock (TH Stick)','FC_TH':'FC (TH Stick)','SP_TH':'SP (TH Stick)','SV_TH':'SV (TH Stick)'
      }[k] || k);
      const headerHuman = ['Week','Region','Plant','Area','Brand','Type', ...headers.slice(6).map(mapKey)];
      const lines = [headerHuman.join(sep)];
      for (const r of rows) {
        const vals = [
          r.Week, r.Region, r.Plant, r.Area, r.Brand, r.Type,
          r[headers[6]]||0, r[headers[7]]||0, r[headers[8]]||0, r[headers[9]]||0, r[headers[10]]||0
        ];
        lines.push(vals.join(sep));
      }
      download(`Filtered_${FILTER.unit.toUpperCase()}.csv`, 'text/csv;charset=utf-8', lines.join('\n'));
    }

    /* =========================================================
       THEME & EVENTS
    ========================================================= */
    function toggleTheme() {
      document.body.classList.toggle('light');
      // repaint charts
      trendChart && trendChart.resize();
      devChart && devChart.resize();
      scatterChart && scatterChart.resize();
    }

    /* =========================================================
       BOOTSTRAP (guard agar tidak double-run)
    ========================================================= */
    if (!window.__TSV_BOOTSTRAPPED__) {
      window.__TSV_BOOTSTRAPPED__ = true;
      document.addEventListener('DOMContentLoaded', bootstrap, { once: true });
    }

    async function bootstrap() {
      const $status = $('#status') || null;
      try {
        $status && ($status.textContent = 'Memuat Data Penjualan (TXT)‚Ä¶');
        RAW = await loadDataFromTXT();

        // Diagnostik aman
        console.log('[TSV] tipe data:', Object.prototype.toString.call(RAW));
        if (Array.isArray(RAW)) console.log('[TSV] Contoh 3 baris:', RAW.slice(0,3));

        // Unit toggle
        $$('input[name="unit"]').forEach(r => r.addEventListener('change', e => {
          FILTER.unit = e.target.value === 'th' ? 'th' : 'pac';
          renderAll();
        }));

        // Filter actions
        $('#applyBtn').addEventListener('click', onApply);
        $('#resetBtn').addEventListener('click', onReset);
        ['regionSel','areaSel','typeSel','brandSel'].forEach(id => {
          $('#'+id).addEventListener('change', updateSelInfo);
        });

        // Export
        $('#btnExportCSV').addEventListener('click', exportCSVFiltered);
        $('#btnTopCSV').addEventListener('click', () => {
          const {top} = computeTopBrands(applyFilter(RAW));
          download('TopBrand_SV.csv','text/csv;charset=utf-8', ['Brand,SV', ...top.map(p=>`${p.Brand},${p.SV}`)].join('\n'));
        });
        $('#btnLowCSV').addEventListener('click', () => {
          const {low} = computeTopBrands(applyFilter(RAW));
          download('LowBrand_SV.csv','text/csv;charset=utf-8', ['Brand,SV', ...low.map(p=>`${p.Brand},${p.SV}`)].join('\n'));
        });
        $('#btnTrendPng').addEventListener('click', ()=>chartToPNG(trendChart, 'Trend.png'));
        $('#btnDevPng').addEventListener('click', ()=>chartToPNG(devChart, 'Deviasi.png'));
        $('#btnScatterPng').addEventListener('click', ()=>chartToPNG(scatterChart, 'Scatter_ES_vs_SV.png'));

        // Theme & resize
        $('#themeBtn').addEventListener('click', toggleTheme);
        window.addEventListener('resize', () => {
          trendChart && trendChart.resize();
          devChart && devChart.resize();
          scatterChart && scatterChart.resize();
        });

        // Init filter & render
        initFilters(RAW);
        renderAll();
      } catch (err) {
        console.error('[TSV] Error loader:', err);
        $status && ($status.textContent = 'Gagal memuat data. Pastikan file data ada & lihat konsol.');
      }
    }

    // Hooks error global (opsional, berguna saat debug di Pages)
    window.addEventListener('error', e => console.error('[GLOBAL ERROR]', e.message, e.error));
    window.addEventListener('unhandledrejection', e => console.error('[PROMISE REJECTION]', e.reason));
  </script>
</body>
</html>


